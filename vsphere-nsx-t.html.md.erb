---
title: Deploying TAS for VMs with NSX-T Networking
owner: Ops Manager
---

This topic describes how to install <%= vars.app_runtime_full %> (<%= vars.app_runtime_abbr %>) on vSphere with NSX-T internal networking, using the VMware NSX-T Container Plug-in for <%= vars.platform_name %>.


## <a id='introduction'></a> Overview

<%= vars.app_runtime_abbr %> uses a Container Network Interface (CNI) plugin to support secure and direct internal communication between containers. This plugin can be:

* The internal Silk plugin that comes packaged with <%= vars.app_runtime_abbr %>, or
* On vSphere, NSX-T Container Plug-in (NCP), which installs as the [VMware NSX-T Container Plug-in for <%= vars.platform_name %>](https://network.pivotal.io/products/vmware-nsx-t) tile in <%= vars.ops_manager %>.

* On vSphere, the NSX-T Container Plug-in (NCP), which is installed as the [VMware NSX-T Container Plug-in for <%= vars.platform_name %>](https://network.tanzu.vmware.com/products/vmware-nsx-t) tile in <%= vars.ops_manager %>.

## <a id='requirements'></a> Prerequisites

Before deploying <%= vars.app_runtime_abbr %> with NSX-T networking, you must have the following:

* An NSX-T environment with NSX-T components installed and configured. The NSX-T version must support the versions of NCP and <%= vars.app_runtime_abbr %> you intend to use. Verify the compatibility between NSX-T, NCP and <%= vars.app_runtime_abbr %> with the following documentation:
   * [Product Interoperability Matrix: <%= vars.app_runtime_abbr %>, VMware NSX-T, and VMware NSX-T Container Plug-in for <%= vars.platform_name %>](https://interopmatrix.vmware.com) for supported version combinations.
   * [VMware NSX-T Data Center Documentation](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/). In particular, review the _NSX Container Plug-in (NCP) Release Notes_ and _NSX-T Data Center Installation Guide_ for the versions of NCP and NSX-T that you want to install.

* BOSH and <%= vars.ops_manager %> installed and configured on vSphere. For more information, see [Deploying <%= vars.ops_manager %> on vSphere](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/vsphere-deploy.html) and [Configuring BOSH Director on vSphere](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/vsphere-config.html).

* The [VMware NSX-T Container Plug-in for <%= vars.platform_name %> tile](https://network.tanzu.vmware.com/products/vmware-nsx-t) is downloaded from VMware Tanzu Network and imported to the <%= vars.ops_manager %> **Installation Dashboard**. For information about downloading and importing VMware Tanzu products to the Installation Dashboard, see [Add and Import Products](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/install-add-delete.html#add-import) in _Adding and Deleting Products_.

* The [<%= vars.app_runtime_abbr %> tile](https://network.tanzu.vmware.com/products/elastic-runtime) is downloaded from VMware Tanzu Network and imported to the <%= vars.ops_manager %> Installation Dashboard. The <%= vars.app_runtime_abbr %> tile must be in one of these states:
  * Configured but not currently deployed. You did not click **Review Pending Changes**, then **Apply Changes** on this version of <%= vars.app_runtime_abbr %>.
  * Deployed previously, with the **Container network interface plugin** field set to **External** in the **Networking** pane of the <%= vars.app_runtime_abbr %> tile.
  <p class="note"><strong>Note:</strong> Deploying <%= vars.app_runtime_abbr %> with its container network interface (CNI) set to <strong>Silk</strong> configures Diego Cells to use an internally-managed container network. Subsequently switching the CNI interface to <strong>External</strong> NSX-T leads to errors.</p>


## <a id='architecture'></a> Architecture

The following diagram shows how to deploy an NSX-T machine to run <%= vars.app_runtime_abbr %> across multiple vSphere hardware clusters. NSX-T runs a Tier-0 (T0) router and multiple Tier-1 (T1) routers, each connecting to a network within <%= vars.platform_name %>. Each vSphere hardware column cluster corresponds to an Availability Zone in <%= vars.platform_name %>:

![alt-text="NSX-T Overview"](./images/nsx-t/nsx-t-refarch.png)

When a developer pushes an app to a new org for the first time, the NSX-T plugin triggers NSX-T to create a new T1 router and allocate an address range for the org, on demand.


## <a id='install'></a> Install and Configure <%= vars.app_runtime_abbr %> and NSX-T

Installing NSX-T to run with <%= vars.app_runtime_abbr %> requires:

1. [Configure NSX-T to Integrate with <%= vars.app_runtime_abbr %>](#nsx-t-setup)

1. [Enable NSX-T Mode in the BOSH Director](#nsx-t-mode)

1. [Configure <%= vars.app_runtime_abbr %> for External Container Networking](#external-net)

1. [Install and Configure the NSX-T Tile](#nsx-t-tile)

### <a id='nsx-t-setup'></a> Set Up NSX-T to Integrate with <%= vars.app_runtime_abbr %>

To set up NSX-T to integrate with <%= vars.app_runtime_abbr %>, complete these procedures:

- [Configure Logical Switches](#nsx-t-logical-switches)

- [Configure Routers](#nsx-t-routers)

- [Configure Load Balancer](#nsx-t-load-balancer)

#### <a id='nsx-t-logical-switches'></a> Configure Logical Switches

To configure logical switches:

1.  In vSphere, create logical network switches to correspond to the networks that <%= vars.platform_name %> uses.
  1. Log in to the **NSX-T Manager Dashboard**.
  1. Go to **Advanced Networking & Security**.
  1. Go to the **Switching** pane.
  1. For each of these networks:

      - **Infrastructure** (BOSH and <%= vars.ops_manager %>, defined in the **Assign AZs and Networks** pane of the BOSH Director tile)
      - **Deployment** (<%= vars.app_runtime_abbr %>, defined in the **Assign AZs and Networks** pane of the <%= vars.app_runtime_abbr %> tile)
      - **Services** and **Dynamic Services** (marketplace services and on-demand services, also defined in the <%= vars.app_runtime_abbr %> tile)
      - **Isolation Segment** (optional, defined in the **Assign AZs and Networks** pane of the Isolation Segment tile) do the following:

          1. Click **+ADD**.
          1. Enter a name for the logical switch (such as `<%= vars.app_runtime_abbr %>-Infrastructure`, `<%= vars.app_runtime_abbr %>-Deployment`).
          1. Click **ADD**.

              ![NSX-T ](./images/nsx-t/nsx-t-logical-switch.png)

#### <a id='nsx-t-routers'></a> Configure Routers

#### <a id='nsx-t-nats'></a> Configure NAT Rules

1. Create T0 network address translation (NAT) rules to communicate with <%= vars.ops_manager %>:

1. Create network address translation (NAT) rules to communicate with <%= vars.ops_manager %>:
  1. Go to **Networking**.
  1. Go to the **NAT** pane.
  1. Select your T0 gateway.
  1. Choose **ADD NAT RULE**.
  1. Add a rule for destination NAT (DNAT) with:
      - The externally-specified destination IP address of incoming requests. If your <%= vars.ops_manager %> has a DNS entry (for example, `opsmgr.example.com`), this is its IP address.
      - The <%= vars.ops_manager %> internal network address.
      - Firewall Setting bypass - the packet bypasses firewall rules.
        ![alt-text=""](./images/nsx-t/nsx-t-dnat-rule.png)
  1. Add the corresponding source NAT (SNAT) rule with:
      - The externally-specified destination IP address.
      - The <%= vars.ops_manager %> internal network address.
      - Firewall Setting bypass - the packet bypasses firewall rules.
        ![alt-text=""](./images/nsx-t/nsx-t-snat-rule.png)
  1. Add a rule for source NAT (SNAT) for the infrastructure and deployment networks:
      - The externally-specified destination IP address.
      - The internal network address in CIDR notation.
      - Firewall Setting bypass - the packet bypasses firewall rules.
        ![alt-text=""](./images/nsx-t/nsx-t-snat-net-rule.png)

1. Create T1 routers for <%= vars.app_runtime_abbr %>, to connect from the T0 router. For each <%= vars.platform_name %> network, Infrastructure, Deployment, and so on, create a T1 router as follows:
1. In the NSX-T Manager UI, navigate to **Advanced Networking & Security** > **Routing** > **Routers**.

    1. Click **+ADD** > **Tier-1 Router**.
    1. Configure the router. Include the Edge Cluster and Edge Cluster Members; they are required to enable the Load Balancer. The Infrastructure network router configuration might look like the following diagram:

        ![NSX-T ](./images/nsx-t/nsx-t-t1-router.png)

1. Create T1 router downlink ports for <%= vars.app_runtime_abbr %>. For each T1 router you created, add a **New Router Port** as follows, to allow traffic in and out:

    1. In the NSX-T Manager UI, select the T1 router.
    1. In **Configuration** > **Router Ports**, click **+ADD** to add a new router port.
    1. For **Logical Switch**, enter the name of the logical switch you defined for the network in **Add New Logical Switch**, above.
    1. For **IP Address**, use the first IP of the appropriate subnet. In this example, 192.168.1.0/24 is set aside for Infrastructure (<%= vars.ops_manager %> and BOSH Director), and 192.168.2.0/24 for the Deployment, so 192.168.1.1 and 192.168.2.1 are used respectively.

        ![NSX-T ](./images/nsx-t/nsx-t-router-port.png)

1. Advertise the routes of the T1 routers to the T0 router, so the T0 router can correctly route incoming requests based on their destination IP address:

1. Create T1 gateways for <%= vars.app_runtime_abbr %>, to connect from the T0 gateway. For each <%= vars.platform_name %> network, Infrastructure, Deployment, and so on, create a T1 gateway as follows:
1. In the NSX-T Manager UI, navigate to **Networking**, then **Tier-1 Gateways**.
  1. Click **ADD TIER-1 GATEWAY**.
  2. Configure the gateway. Include the Edge Cluster as it is required to enable the Load Balancer. T

2. Advertise the routes of the T1 gateways to the T0 gateway, so the T0 gateway can correctly route incoming requests based on their destination IP address:
  1. Edit your T1 Gateway and navigate to **Route Advertisement**.
  2. Enable **All Connected Segments & Service Ports**.
  3. Enable **All LB VIP Routes**. (Required if Load Balancing service is configured.)

3. Allocate an IP block for <%= vars.app_runtime_abbr %> orgs.
  1. From the NSX-T Manager, navigate to **Networking**, then **IP Address Pools**, click "**IP ADDRESS BLOCKS** tab, and click **ADD IP ADDRESS BLOCK**.
  2. Enter a name (for example, `<%= vars.app_runtime_abbr %>-container-ip-block`). This IP block name is also used in the **VMware NSX-T** tile in the **NCP** section under **IP Blocks of Container Networks**.
  3. Enter a description, such as `Subnets are allocated from this pool to each newly-created org`.
  4. Enter a CIDR to allocate an address block large enough to accommodate all <%= vars.app_runtime_abbr %> apps. A `/14` CIDR is large enough for ~1,000 Orgs with ~250 apps each. If you are planning such a large foundation, see [VMware NSX-T <%= vars.app_runtime_abbr %> limits](https://configmax.vmware.com/guest?vmwareproduct=VMware%20NSX-T&release=NSX-T%20Data%20Center%202.4.0&categories=31-0) in the VMware documentation.

4. Create an external SNAT IP pool.
  1. Navigate to **Networking**, then **IP Address Pools**, click "IP ADDRESS POOLS tab, and click **ADD IP ADDRESS POOL**.
  2. Enter a name (such as `external-ip-pool`) and a description (such as `IP pool that provides 1 public IP for each <%= vars.app_runtime_abbr %> Org`). Later, you will enter this pool name on the **VMware NSX-T** tile in the **NCP** section under **IP Pools used to provide External (NAT) IP Addresses to Org Networks**.
  3. Set a subnet of externally routable ip addresses for future NAT ip addresses
    ![alt-text=""](./images/nsx-t/nsx-t-external-ip-pool.png)

#### <a id='nsx-t-segments'></a> Configure Segments

To configure segments:

1.  In vSphere, create segments that correspond to the networks that <%= vars.platform_name %> uses.
  1. Log in to the **NSX-T Manager Dashboard**.
  1. Go to **Networking**.
  1. Go to the **Segments** pane.
  1. For each of these networks...
      - **Infrastructure** (BOSH and <%= vars.ops_manager %>, defined in the **Assign AZs and Networks** pane of the BOSH Director tile)
      - **Deployment** (<%= vars.app_runtime_abbr %>, defined in the **Assign AZs and Networks** pane of the <%= vars.app_runtime_abbr %> tile)
      - **Services** and **Dynamic Services** (marketplace services and on-demand services, also defined in the <%= vars.app_runtime_abbr %> tile)
      - **Isolation Segment** (optional, defined in the **Assign AZs and Networks** pane of the Isolation Segment tile)
    ...do the following:
          1. Click **ADD SEGMENT**.
          1. Enter a name for the segment
          1. Enter a Gateway to connect to.
          1. Click **SAVE**.

#### <a id='nsx-t-load-balancer'></a> Configure Load Balancer

To configure a load balancer:

1. Create Active Monitors (health checks) for use by the virtual servers later on. In the NSX-T Manager UI, navigate to **Networking**, then **Load Balancing**, and click the **Monitors** tab.
    1. Create the health monitor for web load balancing:
    2. Click **Add Active Monitor**.
    3. Select **HTTP**.
        <ul>
           <li><strong>Name</strong>: <code>tas-web-monitor</code></li>
            <li><strong>Monitoring Port</strong>: 8080</li>
            <li><strong>Monitoring Port</strong>: 8080</li>
        </ul>
    4. Configure **Additional Properties**:
        <ul>
            <li><strong>HTTP Request URL</strong>: <code>/health</code></li>
            <li><strong>HTTP Response Code</strong>: 200</li>
        </ul>
    1. Click **Save**.
1. Create the health monitor for TCP load balancing:
    1. Click **ADD ACTIVE MONITOR**.
    2. Select **HTTP**.
        <ul>
            <li><strong>Name</strong>: <code>tas-tcp-monitor</code></li>
            <li><strong>Monitoring Port</strong>: 80</li>
        </ul>
    1. Configure **Additional Properties**:
        <ul>
            <li><strong>HTTP Request URL</strong>: <code>/health</code></li>
            <li><strong>HTTP Response Code</strong>: 200</li>
        </ul>
    1. Click **Save**.
1. Create the health monitor for SSH load balancing:
    1. Click **ADD ACTIVE MONITOR**.
    2. Select **TCP**:
        <ul>
            <li><strong>Name</strong>: <code>tas-ssh-monitor</code></li>
            <li><strong>Monitoring Port</strong>: 2222</li>
        </ul>
    1. Click **Save**.

1. Create Server Pools (collections of VMs which handle traffic) for use by the virtual servers. In the NSX-T Manager UI, navigate to **Networking**, then **Load Balancing**, and click the **Server Pools** tab.
    1. Create the server pool for web load balancing:
    2. Click **Add Server Pool** to add a new pool.
        <ul>
            <li><strong>Name</strong>: <code>tas-web-pool</code></li>
        </ul>
    1. Enter **SNAT Translation**: `Automap`
    2. Click **Select Members**:
        <ul>
            <li><strong>Membership Type</strong>: <code>Static</code></li>
        </ul>
    3. Click **Active Monitor Set**:
        <ul>
            <li>Select <code>tas-web-monitor</code></li>
            <li>Click <strong>Apply</strong></li>
        </ul>
    1. Click **Save**.

1. Create the server pool for TCP load balancing:
    1. Click **Add Server Pool** to add a new pool.
        <ul>
            <li><strong>Name</strong>: <code>tas-tcp-pool</code></li>
        </ul>
    2. Enter **SNAT Translation**: `Disabled`
    3. Click **Select Members**:
        <ul>
            <li><strong>Membership Type</strong>: <code>Static</code></li>
        </ul>
    1. Click **Active Monitor Set**:
        <ul>
            <li>Select <code>tas-tcp-monitor</code></li>
            <li>Click <strong>Apply</strong></li>
        </ul>
    2. Click **Save**.

1. Create the server pool for SSH load balancing:
    1. Click **ADD SERVER POOL** to add a new pool.
        <ul>
            <li><strong>Name</strong>: <code>tas-ssh-pool</code></li>
        </ul>
    2. Enter **SNAT Translation**: `Disabled`
    3. Click **Select Members**:
        <ul>
            <li><strong>Membership Type</strong>: <code>Static</code></li>
        </ul>
    1. Click **Active Monitor Set**:
        <ul>
            <li>Select <code>tas-ssh-monitor</code></li>
            <li>Click <strong>Apply</strong></li>
        </ul>
    1. Click **Save**.

Create virtual servers:

1. In the NSX-T Manager UI, navigate to **Advanced Networking & Security** > **Networking** > **Load Balancing** > **Virtual Servers**.
2. Create the virtual server which forwards unencrypted web (HTTP) traffic to the foundation:

  <p class="note"><strong>Note:</strong> Foundations requiring end-to-end encryption should not enable the virtual server on port 80, or, if enabled, should configure it to redirect traffic to the encrypted port (443).</p>

    1. Click **+ADD**.
    2. Enter **General Properties**:
        - **Name**: `pas-web-vs`
        - **Application Type**: `Layer 4 (TCP)`
        - **Application Profile**: `nsx-default-lb-fast-tcp-profile`
    3. Click **Next**.
    4. Enter **Virtual Server Identifiers**:
        - **IP Address**: use the address of the DNS record of `*.system.YOUR-SYSTEM-DOMAIN.com`
        - **Port**: `80,443`
    5. Enter **Server Pool and Rules**:
        - **Default Server Pool**: `pas-web-pool`
    6. Click **Next** several times, then click **Finish**.
3. Create the virtual server which forwards traffic to apps with custom ports to the foundation:
    1. Click **+ADD** to add a new virtual server.
    2. Enter **General Properties**:
        - **Name**: `pas-tcp-vs`
        - **Application Type**: `Layer 4 (TCP)`
        - **Application Profile**: `nsx-default-lb-fast-tcp-profile`
    3. Click **Next**.
    4. Enter **Virtual Server Identifiers**:
        - **IP Address**: use the address of the DNS record of `tcp.apps.YOUR-SYSTEM-DOMAIN.com`
        - **Port**: use the same ports as configured in the **<%= vars.app_runtime_abbr %> Tile** > **Networking** > **TCP Routing Ports**,
          e.g. `1024-1123,5900`
    5. Click **Next**.
    6. Enter **Server Pool and Rules**:
        - **Default Server Pool**: `pas-tcp-pool`
    7. Click **Next**, then click **Finish**.
4. Create the virtual server which forwards SSH traffic to the foundation:
    1. Click **+ADD** to add a new virtual server.
    2. Enter **General Properties**:
        - **Name**: `pas-ssh-vs`
        - **Application Type**: `Layer 4 (TCP)`
        - **Application Profile**: `nsx-default-lb-fast-tcp-profile`
    3. Click **Next**.
    4. Enter **Virtual Server Identifiers**:
        - **IP Address**: use the address of the DNS record of `ssh.system.YOUR-SYSTEM-DOMAIN.com`
        - **Port**: `2222`
    5. Click **Next**.
    6. Enter **Server Pool and Rules**:
        - **Default Server Pool**: `pas-ssh-pool`
    7. Click **Next**, then click **Finish**.

1. Create the load balancer. In the NSX-T Manager UI, navigate to **Networking**, then **Load Balancing**, and click the **Load Balancers** tab.
    1. Click **ADD LOAD BALANCER**.
      1. Enter the fields:
            <ul>
                <li><strong>Name</strong>: <code>tas-lb</code></li>
                <li><strong>Load Balancer Size</strong>: Select <code>Small</code> unless you have a larger Foundation.</li>
                <li><strong>Attachment</strong>: <code>t1-deployment</code> Attach your load balancer to the Tier 1 gateway fronting your deployment instances.</li>
            </ul>
      2. Click **Save**
      3. Click **Yes** when prompted **Want to continue configuring this Load Balancer?**
      4. Click **Virtual Servers Set**

2. Click **Add Active Monitor**.
3. Select **HTTP**:
    * **Name**: `tas-web-monitor`
    * **Monitoring Port**: 8080.
4. Configure **Additional Properties**:
    * **HTTP Request URL**: `/health`
    * **HTTP Response Code**: 200.
5. Click **Save**.

To create the health monitor for TCP load balancing:

1. Click **Add Active Monitor**.
2. Select **HTTP**:
    * **Name**: `tas-tcp-monitor`
    * **Monitoring Port**: 80.
3. Configure **Additional Properties**:
    * **HTTP Request URL**: `/health`
    * **HTTP Response Code**: 200
4. Click **Save**.

To create the health monitor for SSH load balancing:

1. Click **Add Active Monitor**.
2. Select **TCP**:
    * **Name**: `tas-ssh-monitor`
    * **Monitoring Port**: 2222.
3. Click **Save**.

To create Server Pools (collections of VMs which handle traffic) for use by the virtual servers:

1. In the NSX-T Manager UI, go to **Networking**, then **Load Balancing**.
2. Click the **Server Pools** tab.

To create the server pool for web load balancing:

1. Click **Add Server Pool** : **Name**: `tas-web-pool`
2. Enter **SNAT Translation**: `Automap`
3. Click **Select Members**: **Membership Type**: `Static`
4. Click **Active Monitor Set**:  `tas-web-monitor`
5. Click **Apply**
6. Click **Save**.

To create the server pool for TCP load balancing:

1. Click **Add Server Pool** to add a new pool.
    * **Name**: `tas-tcp-pool`
        1. Enter **SNAT Translation**: `Disabled`
        2. Click **Select Members**: **Membership Type**: `Static`
        3. Click **Active Monitor Set**: `tas-tcp-monitor`
        4. Click **Apply**
        5. Click **Save**.

2. Create the server pool for SSH load balancing:
    1. Click **Add Server Pool** **Name**: `tas-ssh-pool`
    2. Enter **SNAT Translation**: `Disabled`
    3. Click **Select Members**: **Membership Type**: `Static`
    4. Click **Active Monitor Set**: `tas-ssh-monitor`
    5. Click **Apply**.
    6. Click **Save**.

To create the load balancer:

1. In the NSX-T Manager UI, go to **Networking**, then **Load Balancing**.
2. Click the **Load Balancers** tab.
3. Click **Add Load Balancer**.
    1. Enter the fields:
        <ul>
            <li><strong>Name</strong>: <code>tas-lb</code></li>
            <li><strong>Load Balancer Size</strong>: Select <code>Small</code> unless you have a larger Foundation.</li>
            <li><strong>Attachment</strong>: <code>t1-deployment</code> Attach your load balancer to the Tier 1 gateway fronting your deployment instances.</li>
        </ul>
    2. Click **Save**.
    3. Click Yes, when prompted with, **Want to continue configuring this Load Balancer?**.

To create the virtual server that forwards unencrypted web (HTTP) traffic to the foundation.

<p class="note"><strong>Note:</strong> For foundations requiring end-to-end encryption, do not enable the virtual server on port 80. If it must be enabled, configure it to redirect traffic to the encrypted port (443).</p>

1. Click **Virtual Servers Set**.
2. Click **Add Virtual Server**.
3. Select **L4 TCP**.
    * **Name**: `tas-web-vs`
    * **Application Profile**: `default-tcp-lb-app-profile`
    * **IP Address**: use the address of the DNS record of `*.system.YOUR-SYSTEM-DOMAIN.com`
    * **Port**: `80,443`
    * **Server Pool**: `tas-web-pool`
4. Click **Save**.

To create the virtual server that forwards traffic to apps with custom tcp ports to the foundation:

1. Click **Add Virtual Server**.
2. Select **L4 TCP**.
    * **Name**: `tas-tcp-vs`
    * **Application Profile**: `default-tcp-lb-app-profile`
    * **IP Address**: Use the address of the DNS record of `tcp.apps.YOUR-SYSTEM-DOMAIN.com`
    * **Port**: Use the same ports as configured in the **<%= vars.app_runtime_abbr %> Tile**, then **Networking**, and **TCP Routing Ports**. For example: `1024-1123,5900`
    * **Server Pool**: `tas-tcp-pool`
3. Click **Save**.

To create the virtual server that forwards SSH traffic to the foundation:

1. Click **Add Virtual Server**.
2. Select **L4 TCP**.
    * **Name**: `tas-ssh-vs`
    * **Application Profile**: `default-tcp-lb-app-profile`
    * **IP Address**: Use the address of the DNS record of `ssh.system.YOUR-SYSTEM-DOMAIN.com`.
    * **Port**: `2222`
    * **Server Pool**: `tas-ssh-pool`
3. Click **Save**.

### <a id='nsx-t-mode'></a> Enable NSX-T Mode in the BOSH Director

To enable NSX-T mode in the BOSH Director:

1. From the <%= vars.ops_manager %> **Installation Dashboard**, open the **BOSH Director** tile.

1. In the **vCenter Configs** pane, click the pencil icon for the vCenter Config you want to edit.

1. Select **NSX Networking** below.

2. Configure BOSH Director authentication to the NSX Manager by following the **NSX Networking** instructions in the [Step 2: Configure vCenter](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/vsphere-config.html#vcenter-config) section of _Configuring BOSH Director on vSphere_.

3. Verify that the **Use NSX-T Policy API** option is selected.


### <a id='external-net'></a> Configure <%= vars.app_runtime_abbr %> for External Container Networking

To configure <%= vars.app_runtime_abbr %> for external container networking:

1. If you have not already done so, download the <%= vars.app_runtime_abbr %> tile from [VMware Tanzu Network](https://network.tanzu.vmware.com/products/elastic-runtime) and import it to the **Installation Dashboard**.
  <br><br>
  For instructions, see [Add and Import Products](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/install-add-delete.html#add-and-import-products-0).
1. Configure <%= vars.app_runtime_abbr %>, following the directions in [Configuring <%= vars.app_runtime_abbr %>](./configure-pas.html). When you configure **Networking**, select **External** under **Container networking interface plugin**.

    ![alt-text="Ops Manager Installation Dashboard with NSX-T tile"](./images/nsx-t/nsx-t-install-dash.png)

1. Configure <%= vars.app_runtime_abbr %>, following the directions in [Configuring <%= vars.app_runtime_abbr %>](./configure-pas.html). When you configure **Networking**, select **External** under **Container networking interface plugin**.<br>

2. Configure <%= vars.app_runtime_abbr %> to add router, diego_brain, and tcp_router instances to the corresponding NSX-T server pools upon deployment.
     1. Open the <%= vars.app_runtime_abbr %> tile > **Resource Config** pane.
     2. Click the arrow next to each job to reveal the **NSX-T CONFIGURATION** column.
     3. Under **Logical Load Balancer**, fill in the JSON `server_pools` list with the NSX-T Server Pool these instance should be added to upon deployment.
        <ul>
            <li>router -> tas-web-pool</li>
            <li>diego_brain -> tas-ssh-pool</li>
            <li>tcp_router -> tas-tcp-pool</li>
        </ul>
     4. Click **Save**

### <a id='nsx-t-tile'></a> Install and Configure the NSX-T Container Plug-In

To install and configure the tile:

1. If you have not already done so, download the VMware NSX-T Container Plug-in for <%= vars.platform_name %> tile from [VMware Tanzu Network](https://network.tanzu.vmware.com/products/vmware-nsx-t) and import it to the **Installation Dashboard**. For instructions, see [Add and Import Products](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/install-add-delete.html#add-import).
![alt-text="Installation Dashboard with NSX-T tile."](./images/nsx-t/nsx-t-install-dash.png)

        1. If you are using VMware Workspace ONE Access, formerly called VMware Identity Manager
        (vIDM), then select **Client Certificate Authentication**.
        1. Otherwise, select **Basic Authentication with Username and Password** and enter **NSX Manager Admin Username** and **Admin Password** credentials in the fields underneath.

    - **NSX Manager CA Cert**: Obtain this certificate from NSX-T Manager as follows:

        1. `ssh` into NSX-T Manager using the admin account that you created when you deployed NSX-T Manager.
        1. From the NSX-T Manager command line, run `get certificate api` to retrieve the certificate.

            ![NSX-T tile config: NSX-T Manager](./images/nsx-t/nsx-t-tile-config-mgr.png)

1. Open and configure the **NCP** (NSX-T Container Plugin) pane as follows:
     - **<%= vars.app_runtime_abbr %> Foundation Name**: If unsure, use `<%= vars.app_runtime_abbr %>`. If multiple foundations co-exist on the same NSX-T Manager, choose a unique string, such as `<%= vars.app_runtime_abbr %>-beta`. NCP creates artifacts, such as T1 gateways and prefixes their names with this string for easy identification.
     - **Overlay Transport Zone**: A uniquely identifying string for the **Transport Zone** that you chose when you [created segments](#nsx-t-setup) for each network. This can be the name of the transport zone if no other zones in NSX-T share the same name, or else the UUID for the transport zone.
     - **Tier-0 Router**: A uniquely identifying string for the T0 gateway. This can be the tag string that you gave the gateway in NSX-T Manager if no other T0 gateways in NSX-T share the same name, or else the UUID for the gateway.
     - **IP Blocks of Container Networks**: Use the same IP block created [Configure Gateways](#nsx-t-gateways).
    - **Subnet Prefix of Container Networks**: Subnet mask to set the address range size for apps in a single org. Defaults to `24`. This number must be higher than the mask for all <%= vars.app_runtime_abbr %> orgs in the NSX-T Manager **New IP Block** pane, to define each org's fraction of the total <%= vars.app_runtime_abbr %> address space.
    - **IP Pools used to provide External (NAT) IP Addresses to Org Networks**: Use the same IP Pool created iin [Configure Gateways](#nsx-t-gateways).
    - **Enable NSX-T Policy API**: Enable this checkbox to use the new Policy API.

2. In the **NSX Node Agent** pane, enable the **Enable Debug Level of Logging for NSX Node Agent** checkbox.
    ![alt-text="NSX-T tile config: NSX-T Node Agent"](./images/nsx-t/nsx-t-tile-config-agent.png)

3. Click **Save** and return to the **Installation Dashboard**.

4. After you have configured both the **<%= vars.app_runtime_abbr %>** tile and the **VMware NSX-T** tile, click **Review Pending Changes**, then **Apply Changes** to deploy <%= vars.app_runtime_abbr %> with NSX-T networking.


## <a id='upgrade'></a> Upgrade <%= vars.app_runtime_abbr %> with NSX-T Networking

After you have deployed <%= vars.app_runtime_abbr %> with NSX-T, you may need to upgrade either <%= vars.ops_manager %>, <%= vars.app_runtime_abbr %>, the NSX-T Container Plug-in or NSX-T Data Center. If you upgrade one of these components, you may need to upgrade the other components as well.

For example, if you want to upgrade NSX-T Data Center, you may need to upgrade the NSX-T Container Plug-in first.

To upgrade <%= vars.app_runtime_abbr %> with NSX-T Networking:

1. Plan the upgrade by determining the compatibility of NCP, NSX-T and <%= vars.app_runtime_abbr %> by checking the following documentation:
   * See [Product Interoperability Matrix: <%= vars.app_runtime_abbr %>, VMware NSX-T, and VMware NSX-T Container Plug-in for <%= vars.platform_name %>](https://interopmatrix.vmware.com) for supported version combinations.
   * See [VMware NSX-T Data Center Documentation](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/). In particular, review the _NSX Container Plug-in (NCP) Release Notes_ and _NSX-T Data Center Installation Guide_ for the versions of NCP and NSX-T that you want to install.

2. Download the desired version of VMware NSX-T Container Plug-in for <%= vars.platform_name %> tile from [VMware Tanzu Network](https://network.tanzu.vmware.com/products/vmware-nsx-t).

3. In <%= vars.ops_manager %>, import the new version of the tile to the **Installation Dashboard**. For instructions, see [Adding and Importing Products](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/install-add-delete.html#add-import).

4. Click **Review Pending Changes** and review your changes.

5. Click **Apply Changes**.

1. Continue with the upgrade of <%= vars.ops_manager %>, <%= vars.app_runtime_abbr %>, or NSX-T Data Center. For more information, see [Upgrade NCP in a <%= vars.platform_name %> Environment](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.4/com.vmware.nsxt.ncp_kubernetes.doc/GUID-4E269C79-1EF7-48E7-AFA4-D79B9F9C9202.html?hWord=N4IghgNiBcIK4AcDmAnMATApgAgHYGMEQBfIA) in the VMware NSX-T Data Center documentation.
